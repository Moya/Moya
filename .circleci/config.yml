version: 2.1
defaults: &defaults
  machine: true
  resource_class: frankois944/macos
  shell: /bin/bash --login
  environment:
    CIRCLE_ARTIFACTS: /tmp/circleci-artifacts
    CIRCLE_TEST_REPORTS: /tmp/circleci-test-results
    LANG: en_US.UTF-8
jobs:
  carthage_without_swiftlint_integration:
    <<: *defaults
    steps:
      - checkout
      - run: mkdir -p $CIRCLE_ARTIFACTS $CIRCLE_TEST_REPORTS
      - restore_cache:
          keys:
            - v{{ .Environment.CACHE_VERSION }}-carthage-no-swiftlint-deps-{{ checksum "Cartfile.resolved" }}
      - run:
          name: Set Ruby Version
          command: echo "3.1.2" > .ruby-version
      - run:
          name: Upgrade Carthage
          command: brew outdated carthage || brew upgrade carthage
      - run:
          name: Carthage checkout
          command: carthage checkout
      - run:
          name: Test Carthage Build before installing SwiftLint
          command: carthage build --no-skip-current --cache-builds --no-use-binaries --verbose --use-xcframeworks
      - save_cache:
          key: v{{ .Environment.CACHE_VERSION }}-carthage-no-swiftlint-deps-{{ checksum "Cartfile.resolved" }}
          paths:
            - Carthage               
  build:
    <<: *defaults
    steps:
      - checkout
      - run: mkdir -p $CIRCLE_ARTIFACTS $CIRCLE_TEST_REPORTS
      - restore_cache:
          keys:
            - v{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-dep-ruby-carthage-{{ checksum "Cartfile.resolved" }}
      - run:
          name: Set Ruby Version
          command: echo "3.1.2" > .ruby-version
      - run:
          name: Install Swiftlint
          command: brew install swiftlint    
      - run:
          name: Install Ruby Dependencies
          command: bundle check || bundle install
          environment:
            BUNDLE_JOBS: 4
            BUNDLE_RETRY: 3
      - run:
          name: Upgrade Carthage
          command: brew outdated carthage || brew upgrade carthage
      - run:
          name: Carthage checkout
          command: carthage checkout
      - run: 
          name: Bootstrap Carthage
          command: carthage build --use-xcframeworks --cache-builds --platform iOS,macOS,tvOS
      - save_cache:
          key: v{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-dep-ruby-carthage-{{ checksum "Cartfile.resolved" }}
          paths:
            - vendor/bundle
            - Carthage
      - run: 
          name: Test on iOS
          command: rake test:ios
      - run: 
          name: Test on macOS
          command: rake test:macos
      - run:
          name: Test on tvOS
          command: rake test:tvos
      - run: 
          name: Test with Carthage
          command: rake test:carthage
      - run:
          name: Build Example Project
          command: rake build_example
      - run:
          name: Install MDSpell
          command: sudo npm install -g orta/node-markdown-spellcheck
      - restore_cache:
          keys:
          - v{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-danger-dependencies-{{ checksum "Dangerfile.swift" }}
      - run:
          name: Run Danger
          command: brew install danger/tap/danger-swift && danger-swift ci
      - save_cache:
          key: v{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-danger-dependencies-{{ checksum "Dangerfile.swift" }}
          paths:
            - .danger-swift
      - run:
          name: CocoaPods Spec linting
          command: bundle exec pod lib lint --allow-warnings
      - run:
          name: Send Code Coverage to Codecov.io
          command: bash <(curl -s https://codecov.io/bash) -J Moya
      - run:
          name: Store Xcode Activity Log
          command: find $HOME/Library/Developer/Xcode/DerivedData -name '*.xcactivitylog' -exec cp {} $CIRCLE_ARTIFACTS/xcactivitylog \; || true
      - store_test_results:
          path: /tmp/circleci-test-results
      - store_artifacts:
          path: /tmp/circleci-artifacts
      - store_artifacts:
          path: /tmp/circleci-test-results
workflows:
  pr_build:
    jobs:
      - build
      - carthage_without_swiftlint_integration
